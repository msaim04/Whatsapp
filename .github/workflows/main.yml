name: Deploy Frontend (WhatsApp Website)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-frontend:
    name: Deploy WhatsApp Website
    runs-on: ubuntu-latest
    environment: production

    steps:
    # ---------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ---------------------------------------------------
    - name: Setup Node.js (npm)
      uses: actions/setup-node@v4
      with:
        node-version: 20.9.0
        cache: npm

    # ---------------------------------------------------
    - name: Install dependencies
      run: npm ci

    # ---------------------------------------------------
    - name: Build Next.js (Standalone)
      run: |
        echo "Building Next.js..."
        npm run build

    # ---------------------------------------------------
    - name: Validate build output
      run: |
        if [ ! -d ".next/standalone" ]; then
          echo "❌ Standalone build missing."
          exit 1
        fi
        echo "✔ Build structure OK"

    # ---------------------------------------------------
    # Prepare server directory
    # ---------------------------------------------------
    - name: Prepare server directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          sudo mkdir -p /var/www/whatsapp-website
          sudo chown -R $USER:$USER /var/www/whatsapp-website
          sudo mkdir -p /var/www/whatsapp-website-backups
          echo "✔ Server directory ready."

    # ---------------------------------------------------
    # Backup existing deployment
    # ---------------------------------------------------
    - name: Backup current version
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          TARGET=/var/www/whatsapp-website
          BACK=/var/www/whatsapp-website-backups

          if [ -d "$TARGET" ]; then
            rm -rf "$BACK/backup-3"
            mv "$BACK/backup-2" "$BACK/backup-3" 2>/dev/null || true
            mv "$BACK/backup-1" "$BACK/backup-2" 2>/dev/null || true
            mv "$TARGET" "$BACK/backup-1"
            echo "✔ Backup created."
          else
            echo "No previous deployment found."
          fi

    # ---------------------------------------------------
    # Upload filess
    # ---------------------------------------------------
    - name: Upload build files
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

        TARGET="/var/www/whatsapp-website"

        echo "Uploading..."
        rsync -az --delete .next/standalone/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$TARGET/
        rsync -az .next/static/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$TARGET/.next/static/
        rsync -az public/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$TARGET/public/
        rsync -az package.json package-lock.json ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$TARGET/

        echo "✔ Upload complete."

    # ---------------------------------------------------
    - name: Install dependencies on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /var/www/whatsapp-website
          npm ci --omit=dev
          echo "✔ Server dependencies installed."

    # ---------------------------------------------------
    # Start PM2 (correct standalone command)
    # ---------------------------------------------------
    - name: Restart PM2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd /var/www/whatsapp-website
          pm2 delete whatsapp_frontend || true
          PORT=3002 pm2 start server.js --name whatsapp_frontend
          pm2 save
          echo "✔ PM2 restarted."

    # ---------------------------------------------------
    - name: Reload Nginx
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          sudo nginx -t
          sudo systemctl reload nginx
          echo "✔ Nginx reloaded."

    # ---------------------------------------------------
    - name: Health Check
      id: health
      run: |
        STATUS=$(curl -o /dev/null -s -w "%{http_code}" "${{ secrets.FRONTEND_URL }}")
        echo "Status: $STATUS"
        if [ "$STATUS" = "200" ]; then
          echo "health=ok" >> $GITHUB_OUTPUT
        else
          echo "health=fail" >> $GITHUB_OUTPUT
        fi

    # ---------------------------------------------------
    - name: Rollback if failed
      if: steps.health.outputs.health == 'fail'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          B=/var/www/whatsapp-website-backups/backup-1
          T=/var/www/whatsapp-website

          if [ -d "$B" ]; then
            rm -rf "$T"
            mv "$B" "$T"
            cd "$T"
            pm2 delete whatsapp_frontend || true
            PORT=3002 pm2 start server.js --name whatsapp_frontend
            pm2 save
            sudo systemctl reload nginx
            echo "✔ Rollback applied."
          else
            echo "❌ No backup available."
            exit 1
